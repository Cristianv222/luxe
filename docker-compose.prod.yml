# docker-compose.prod.yml
# Archivo exclusivo para producción.
# Desplegar con: docker compose -f docker-compose.prod.yml --env-file .env up -d --build
#
# Requisitos previos:
#   docker network create proxy-network   (si no existe aún)
#   docker network create luxe_network    (se crea automático al levantar)

services:

  # ─────────────────────────────────────────
  # PostgreSQL — base de datos
  # ─────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: luxe_postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data/pgdata
      - ./backups:/backups
    environment:
      POSTGRES_USER:              postgres
      POSTGRES_PASSWORD:          ${POSTGRES_PASSWORD}
      POSTGRES_DB:                luxe_service_db
      POSTGRES_HOST_AUTH_METHOD:  md5
      PGDATA:                     /var/lib/postgresql/data/pgdata
    # Sin 'ports:' — la DB no debe ser accesible desde el host
    expose:
      - "5432"
    networks:
      - luxe-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 100
        hard: 200
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus:   '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d luxe_service_db"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ─────────────────────────────────────────
  # Redis — caché y sesiones
  # ─────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: luxe_redis
    command: sh -c 'exec redis-server --requirepass "$$REDIS_PASSWORD" --save "" --appendonly no'
    expose:
      - "6379"
    networks:
      - luxe-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 100
        hard: 200
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus:   '0.10'
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ─────────────────────────────────────────
  # Django / Gunicorn — backend
  # ─────────────────────────────────────────
  luxe-service:
    image: luxe-service:${APP_VERSION:-1.0.0}   # Tag semántico, NUNCA :latest
    container_name: luxe_service
    build:
      context: ./luxe-service
      dockerfile: Dockerfile
      target: production
    command: >
      sh -c "
      python manage.py migrate --noinput &&
      python manage.py collectstatic --noinput &&
      exec gunicorn
        --bind 0.0.0.0:8000
        --workers 3
        --timeout 120
        --max-requests 1000
        --max-requests-jitter 100
        --limit-request-line 4094
        --limit-request-fields 100
        --access-logfile -
        --error-logfile -
        luxe_service.wsgi:application"
    volumes:
      - luxe-static:/app/staticfiles
      - media-volume:/app/media
      - logs-volume:/app/logs
    env_file:
      - .env
    environment:
      # Aplicación
      DEBUG:                          "False"
      PYTHONUNBUFFERED:               "1"
      ALLOWED_HOSTS:                  ${ALLOWED_HOSTS:-luxury.fronteratech.ec,luxe-service}
      CORS_ALLOWED_ORIGINS:           ${CORS_ALLOWED_ORIGINS:-https://luxury.fronteratech.ec}
      CSRF_TRUSTED_ORIGINS:           ${CSRF_TRUSTED_ORIGINS:-https://luxury.fronteratech.ec}
      TZ:                             ${TIME_ZONE:-America/Guayaquil}
      LOG_LEVEL:                      ${LOG_LEVEL:-INFO}
      # Seguridad SSL/HTTP
      SECURE_SSL_REDIRECT:            ${SECURE_SSL_REDIRECT:-True}
      SESSION_COOKIE_SECURE:          ${SESSION_COOKIE_SECURE:-True}
      CSRF_COOKIE_SECURE:             ${CSRF_COOKIE_SECURE:-True}
      SECURE_BROWSER_XSS_FILTER:      "True"
      SECURE_CONTENT_TYPE_NOSNIFF:    "True"
      SECURE_HSTS_SECONDS:            "31536000"   # HSTS por 1 año
      SECURE_HSTS_INCLUDE_SUBDOMAINS: "True"
      SECURE_HSTS_PRELOAD:            "True"
      X_FRAME_OPTIONS:                "DENY"       # Previene clickjacking
    expose:
      - "8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - luxe-network
      - proxy-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:size=64m,mode=1777
      - /var/cache:size=32m
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 100
        hard: 200
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus:   '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "--max-time", "5", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────
  # React / Nginx — frontend
  # ─────────────────────────────────────────
  frontend:
    image: luxe-frontend:${APP_VERSION:-1.0.0}   # Tag semántico, NUNCA :latest
    container_name: luxe_frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    environment:
      NODE_ENV:                   production
      REACT_APP_API_BASE_URL:     ${REACT_APP_API_BASE_URL:-https://luxury.fronteratech.ec}
      REACT_APP_AUTH_SERVICE:     ${REACT_APP_AUTH_SERVICE:-https://luxury.fronteratech.ec}
      REACT_APP_LUXE_SERVICE:     ${REACT_APP_LUXE_SERVICE:-https://luxury.fronteratech.ec/api/luxe}
    expose:
      - "8080"
    depends_on:
      - luxe-service
    networks:
      - luxe-network
      - proxy-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:size=32m,mode=1777
      - /var/run:size=8m,mode=0777
      - /var/cache/nginx:size=64m,mode=0777
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus:   '0.10'
          memory: 64M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ─────────────────────────────────────────────────────────────
# Volúmenes
# ─────────────────────────────────────────────────────────────
volumes:
  postgres-data:
    name: luxe_postgres_data
    driver: local
  luxe-static:
    name: luxe_service_static
    driver: local
  media-volume:
    name: luxe_service_media
    driver: local
  # logs como volumen nombrado en vez de bind mount ./logs
  # El bind mount rompería read_only:true porque montaría desde el host
  logs-volume:
    name: luxe_service_logs
    driver: local

# ─────────────────────────────────────────────────────────────
# Redes
# ─────────────────────────────────────────────────────────────
networks:
  # Red interna Docker: postgres y redis NO están expuestos al proxy
  luxe-network:
    driver: bridge
    name: luxe_network
  # Red externa donde vive el reverse proxy (Traefik / Nginx Proxy Manager)
  # Crear manualmente: docker network create proxy-network
  proxy-network:
    external: true
    name: proxy-network
